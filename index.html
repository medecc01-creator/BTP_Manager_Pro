<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestion de Chantier BTP</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f1f5f9; font-family: system-ui; overflow: hidden; }
        .custom-scrollbar-h { overflow-x: auto !important; -webkit-overflow-scrolling: touch; }
        .sticky-col { position: sticky; left: 0; z-index: 45; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // CONFIGURATION SUPABASE
        const SUPABASE_URL = 'https://ljitxlqkdkoaxgvfeuxh.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_p1t5UNCV5ODa0wNAM1LwYw_YmPIkRrl';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function App() {
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [debugMsg, setDebugMsg] = useState("Démarrage...");

            const params = new URLSearchParams(window.location.search);
            const projectId = params.get('id');
            const currentView = params.get('view') || 'details';

            // Initialisation et Chargement
            useEffect(() => {
                const init = async () => {
                    try {
                        setDebugMsg("Vérification session...");
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        
                        if (!session) {
                            window.location.href = 'index.html';
                            return;
                        }

                        setDebugMsg("Récupération des données...");
                        const { data, error: dbError } = await supabaseClient
                            .from('btp_data')
                            .select('content')
                            .eq('id', 1)
                            .maybeSingle();

                        if (dbError) throw dbError;

                        const content = data ? JSON.parse(data.content) : [];
                        setProjects(content);
                        setLoading(false);
                        setDebugMsg("OK");

                    } catch (err) {
                        console.error(err);
                        setError(err.message);
                        setDebugMsg("Erreur critique : " + err.message);
                    }
                };
                init();
            }, []);

            // Sauvegarde automatique
            const syncData = async (newProjects) => {
                setProjects(newProjects);
                try {
                    await supabaseClient.from('btp_data').upsert({ 
                        id: 1, 
                        content: JSON.stringify(newProjects), 
                        lastUpdate: new Date().toISOString() 
                    });
                } catch (e) { console.error("Sync Error", e); }
            };

            // Filtrage du projet actif avec sécurité
            const activeProject = useMemo(() => {
                return projects.find(p => p.id === projectId) || null;
            }, [projects, projectId]);

            // Calcul du planning avec sécurité anti-boucle
            const ganttDays = useMemo(() => {
                if (!activeProject) return [];
                try {
                    const today = new Date();
                    let start = new Date(today);
                    start.setDate(start.getDate() - 5);
                    let end = new Date(today);
                    end.setDate(end.getDate() + 40);

                    const days = [];
                    let loopSafety = 0;
                    for (let d = new Date(start); d <= end && loopSafety < 100; d.setDate(d.getDate() + 1)) {
                        days.push(new Date(d));
                        loopSafety++;
                    }
                    return days;
                } catch (e) { return []; }
            }, [activeProject]);

            // Écran de chargement amélioré
            if (loading) return (
                <div className="flex flex-col h-screen items-center justify-center bg-slate-50 p-6 text-center">
                    <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <h2 className="text-lg font-black uppercase text-slate-800">Chargement du chantier...</h2>
                    <p className="text-xs text-slate-400 mt-2 font-mono">{debugMsg}</p>
                    {error && (
                        <button onClick={() => window.location.reload()} className="mt-6 px-6 py-3 bg-red-500 text-white rounded-xl font-bold uppercase text-xs">
                            Réessayer la connexion
                        </button>
                    )}
                </div>
            );

            if (!activeProject) return (
                <div className="flex h-screen items-center justify-center p-6 text-center">
                    <div>
                        <p className="font-bold text-slate-400 mb-4">Projet introuvable ou erreur de lien.</p>
                        <a href="index.html" className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-xs">Retour à l'accueil</a>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-screen bg-slate-50 overflow-hidden">
                    {/* Header Minimal */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 shadow-xl">
                        <div className="flex flex-col">
                            <span className="text-[10px] font-black text-blue-400 uppercase tracking-tighter italic">BTP Manager Pro</span>
                            <h1 className="text-xs font-bold truncate max-w-[150px] uppercase opacity-80">{activeProject.name}</h1>
                        </div>
                        <a href="index.html" className="bg-white/10 p-2 rounded-lg text-[10px] font-black uppercase">Fermer</a>
                    </header>

                    {/* Contenu Principal */}
                    <main className="flex-1 overflow-y-auto pb-32 p-4">
                        {currentView === 'details' && (
                            <div className="max-w-md mx-auto space-y-4">
                                {activeProject.tasks.map(task => (
                                    <div key={task.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                        <h3 className="text-[10px] font-black text-blue-600 uppercase mb-3">{task.title}</h3>
                                        <div className="space-y-2">
                                            {task.subtasks.map(sub => (
                                                <div key={sub.id} className="flex flex-col gap-1 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                    <span className="text-[11px] font-bold uppercase text-slate-700">{sub.title}</span>
                                                    <div className="flex gap-2 mt-1">
                                                        <input type="date" value={sub.date} onChange={(e) => {
                                                            const newData = projects.map(p => p.id === projectId ? {
                                                                ...p, tasks: p.tasks.map(t => t.id === task.id ? {
                                                                    ...t, subtasks: t.subtasks.map(s => s.id === sub.id ? {...s, date: e.target.value} : s)
                                                                } : t)
                                                            } : p);
                                                            syncData(newData);
                                                        }} className="text-[10px] font-bold p-1 rounded bg-white border flex-1" />
                                                        <div className="flex items-center bg-white border rounded px-2">
                                                            <input type="number" value={sub.duration} onChange={(e) => {
                                                                const newData = projects.map(p => p.id === projectId ? {
                                                                    ...p, tasks: p.tasks.map(t => t.id === task.id ? {
                                                                        ...t, subtasks: t.subtasks.map(s => s.id === sub.id ? {...s, duration: e.target.value} : s)
                                                                    } : t)
                                                                } : p);
                                                                syncData(newData);
                                                            }} className="w-8 text-[10px] font-bold text-center" />
                                                            <span className="text-[8px] font-bold opacity-30">J</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentView === 'planning' && (
                            <div className="bg-white rounded-2xl shadow-sm overflow-hidden border flex flex-col h-full">
                                <div className="custom-scrollbar-h flex-1">
                                    <div className="inline-block min-w-full">
                                        <div className="flex bg-slate-800 text-white sticky top-0 z-50">
                                            <div className="w-24 shrink-0 p-2 text-[8px] font-black border-r border-white/10 uppercase bg-slate-900 sticky left-0">Tâche</div>
                                            {ganttDays.map((d, i) => (
                                                <div key={i} className="w-8 shrink-0 text-center py-2 border-r border-white/5 text-[9px] font-bold">
                                                    {d.getDate()}
                                                </div>
                                            ))}
                                        </div>
                                        {activeProject.tasks.map(task => (
                                            <div key={task.id} className="border-b">
                                                {task.subtasks.map(sub => {
                                                    const startIdx = ganttDays.findIndex(d => d.toDateString() === new Date(sub.date).toDateString());
                                                    return (
                                                        <div key={sub.id} className="flex h-8 items-center relative border-t border-slate-50">
                                                            <div className="w-24 shrink-0 px-2 text-[8px] font-bold text-slate-500 sticky left-0 bg-white border-r truncate">{sub.title}</div>
                                                            {ganttDays.map((_, i) => <div key={i} className="w-8 shrink-0 h-full border-r border-slate-50"></div>)}
                                                            {startIdx !== -1 && (
                                                                <div className="absolute h-4 bg-blue-600 rounded-sm z-20 shadow-sm" 
                                                                    style={{left: (96 + startIdx * 32)+'px', width: (Math.max(1, sub.duration) * 32)+'px'}}>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Ajoutez les autres vues (tracking, budget) ici sur le même modèle simple */}
                    </main>

                    {/* Navigation Basse */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 pb-8 flex justify-around shadow-2xl z-50">
                        {[{id:'details', label:'Lots'}, {id:'planning', label:'Planning'}].map(item => (
                            <button key={item.id} onClick={() => window.location.href=`gestion.html?id=${projectId}&view=${item.id}`} className={`flex flex-col items-center ${currentView === item.id ? 'text-blue-600' : 'text-slate-300'}`}>
                                <span className="text-[10px] font-black uppercase">{item.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
