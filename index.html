<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTP Manager Pro - Android Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; font-family: sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKpd67l8OKVmvkqMYTrT1oh0c_9q5tKys",
            authDomain: "btp-manager-pro.firebaseapp.com",
            projectId: "btp-manager-pro",
            storageBucket: "btp-manager-pro.firebasestorage.app",
            messagingSenderId: "491801562192",
            appId: "1:491801562192:web:5cc53257ae5f641a6b9555"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.FirebaseOps = {
            saveData: async (data) => {
                await setDoc(doc(db, "data", "btp_v3_main"), { content: JSON.stringify(data), lastUpdate: new Date().toISOString() });
            },
            subscribeData: (callback) => {
                return onSnapshot(doc(db, "data", "btp_v3_main"), (doc) => {
                    if (doc.exists()) callback(JSON.parse(doc.data().content));
                    else callback([]);
                });
            },
            initAuth: () => signInAnonymously(auth)
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- CONFIGURATION CLOUDINARY ---
        const CLOUD_NAME = "dzhkqkzrg";
        const UPLOAD_PRESET = "BTP_MP"; // Nom exact vérifié sur votre capture

        const Icon = ({ name, size = 20 }) => {
            const icons = {
                camera: <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>,
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/>,
                home: <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">{icons[name] || null}</svg>;
        };

        function App() {
            const [view, setView] = useState('projects'); 
            const [projects, setProjects] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                if (window.FirebaseOps) {
                    window.FirebaseOps.initAuth().then(() => {
                        window.FirebaseOps.subscribeData(setProjects);
                    });
                }
            }, []);

            const activeProject = projects.find(p => p.id === selectedId);

            const handleUpload = async (tId, sId, file) => {
                if (!file) return;
                setUploading(true);
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                try {
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message);

                    const newProjects = projects.map(p => p.id === selectedId ? {
                        ...p, tasks: p.tasks.map(t => t.id === tId ? {
                            ...t, subtasks: t.subtasks.map(s => s.id === sId ? {
                                ...s, photos: [...(s.photos || []), data.secure_url]
                            } : s)
                        } : t)
                    } : p);
                    
                    setProjects(newProjects);
                    window.FirebaseOps.saveData(newProjects);
                } catch (err) {
                    alert("Erreur Android/Cloudinary : " + err.message);
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-100">
                    <header className="bg-slate-900 text-white p-4 font-bold flex justify-between">
                        <span>BTP MANAGER PRO</span>
                        {uploading && <span className="text-xs animate-pulse text-blue-400">ENVOI...</span>}
                    </header>

                    <main className="flex-1 overflow-y-auto p-4">
                        {view === 'projects' && (
                            <div className="space-y-4">
                                {projects.map(p => (
                                    <div key={p.id} onClick={() => { setSelectedId(p.id); setView('tracking'); }} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                        {p.name}
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'tracking' && activeProject && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-bold">{activeProject.name}</h2>
                                {activeProject.tasks.map(task => (
                                    <div key={task.id} className="bg-white p-4 rounded-3xl shadow-sm">
                                        <p className="text-xs font-bold text-slate-400 mb-4">{task.title}</p>
                                        {task.subtasks.map(sub => (
                                            <div key={sub.id} className="mb-6 border-b pb-4 last:border-0">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="font-bold text-sm">{sub.title}</span>
                                                    <label className="p-2 bg-blue-50 text-blue-600 rounded-full">
                                                        <Icon name="camera" />
                                                        <input type="file" accept="image/*" capture="environment" className="hidden" onChange={e => handleUpload(task.id, sub.id, e.target.files[0])} />
                                                    </label>
                                                </div>
                                                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                                    {sub.photos?.map((p, i) => (
                                                        <div key={i} className="w-16 h-16 rounded-xl overflow-hidden shrink-0 border border-slate-100">
                                                            {/* MINIATURE OPTIMISÉE */}
                                                            <img src={p.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/')} className="w-full h-full object-cover" />
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <nav className="bg-white border-t p-4 flex justify-around">
                        <button onClick={() => setView('projects')} className="flex flex-col items-center text-slate-400"><Icon name="home" /><span className="text-[10px]">PROJETS</span></button>
                        <button onClick={() => setView('tracking')} className="flex flex-col items-center text-blue-600"><Icon name="camera" /><span className="text-[10px]">SUIVI</span></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
