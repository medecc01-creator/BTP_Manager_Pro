<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTP Manager Pro (Auth)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    </head>
<body>
    <div id="root"></div>

    <script type="text/javascript">
        // CONFIGURATION
        const SUPABASE_URL = 'https://ljitxlqkdkoaxgvfeuxh.supabase.co';
        const SUPABASE_ANON_KEY = 'TON_ANON_KEY_ICI'; // À RÉCUPÉRER DANS SETTINGS > API
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.DatabaseOps = {
            saveData: async (data) => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                await supabaseClient.from('btp_data').upsert({ 
                    id: 1, 
                    content: JSON.stringify(data), 
                    lastUpdate: new Date().toISOString() 
                });
            },
            subscribeData: (callback) => {
                supabaseClient.from('btp_data').select('content').eq('id', 1).single()
                    .then(({ data }) => { if (data) callback(JSON.parse(data.content)); });

                const channel = supabaseClient.channel('db-changes')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'btp_data' }, 
                        payload => callback(JSON.parse(payload.new.content))
                    ).subscribe();
                return () => supabaseClient.removeChannel(channel);
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Login({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (type) => {
                setLoading(true);
                const { data, error } = type === 'up' 
                    ? await supabaseClient.auth.signUp({ email, password })
                    : await supabaseClient.auth.signInWithPassword({ email, password });
                
                if (error) alert(error.message);
                else if (data.user) onLogin(data.user);
                setLoading(false);
            };

            return (
                <div className="h-screen flex items-center justify-center bg-slate-900 p-6">
                    <div className="bg-white p-8 rounded-[40px] w-full max-w-sm shadow-2xl text-center">
                        <img src="https://res.cloudinary.com/dzhkqkzrg/image/upload/v1734863336/Logo_Manager_Pro_copie_m68hda.png" className="w-16 mx-auto mb-6" />
                        <h2 className="font-black uppercase italic mb-6">Connexion BTP Pro</h2>
                        <input type="email" placeholder="Email" className="w-full p-4 bg-slate-100 rounded-2xl mb-3 outline-none" onChange={e => setEmail(e.target.value)} />
                        <input type="password" placeholder="Mot de passe" className="w-full p-4 bg-slate-100 rounded-2xl mb-6 outline-none" onChange={e => setPassword(e.target.value)} />
                        <div className="flex flex-col gap-3">
                            <button onClick={() => handleAuth('in')} disabled={loading} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest">{loading ? '...' : 'Se connecter'}</button>
                            <button onClick={() => handleAuth('up')} className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Créer un compte</button>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('projects');
            const [projects, setProjects] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                // Vérifier session existante
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) setUser(session.user);
                    setIsLoading(false);
                });
            }, []);

            useEffect(() => {
                if (user) {
                    const unsub = window.DatabaseOps.subscribeData(setProjects);
                    return unsub;
                }
            }, [user]);

            useEffect(() => {
                if (user && projects.length > 0) window.DatabaseOps.saveData(projects);
            }, [projects]);

            if (isLoading) return <div className="h-screen flex items-center justify-center font-black animate-pulse uppercase">Initialisation...</div>;
            if (!user) return <Login onLogin={setUser} />;

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <img src="https://res.cloudinary.com/dzhkqkzrg/image/upload/v1734863336/Logo_Manager_Pro_copie_m68hda.png" className="w-8 h-8"/>
                            <span className="text-[8px] font-bold">{user.email}</span>
                        </div>
                        <button onClick={() => supabaseClient.auth.signOut().then(() => setUser(null))} className="text-[8px] font-bold uppercase opacity-50">Déconnexion</button>
                    </header>
                    {/* ... [Reste de ton interface de gestion de projets] ... */}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
