<script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const CLOUD_NAME = "dzhkqrg";
    const UPLOAD_PRESET = "BTP_MP";

    // Ajout des icônes Up/Down dans le composant Icon
    const Icon = ({ name, size = 20, color = "currentColor" }) => {
        const icons = {
            home: <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>,
            calendar: <><rect width="18" height="18" x="3" y="4" rx="2" /><path d="M16 2v4M8 2v4M3 10h18" /></>,
            edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>,
            wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/>,
            camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
            trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
            x: <path d="M18 6 6 18M6 6l12 12" />,
            logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
            left: <path d="m15 18-6-6 6-6" />,
            right: <path d="m9 18 6-6-6-6" />,
            up: <path d="m18 15-6-6-6 6" />,
            down: <path d="m6 9 6 6 6-6" />
        };
        return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">{icons[name]}</svg>;
    };

    function App() {
        const [user, setUser] = useState(null);
        const [loginData, setLoginData] = useState({ email: '', password: '' });
        const [view, setView] = useState('projects');
        const [projects, setProjects] = useState([]);
        const [selectedId, setSelectedId] = useState(null);
        const [isSyncing, setIsSyncing] = useState(false);
        const [ganttZoom, setGanttZoom] = useState(40);
        const [viewer, setViewer] = useState({ photos: [], index: 0, open: false, taskId: null, subId: null });
        const [dialog, setDialog] = useState({ open: false, title: '', value: '', onConfirm: null, type: 'input' });
        const [linkDialog, setLinkDialog] = useState({ open: false, taskId: null, subId: null });

        useEffect(() => {
            supabaseClient.auth.getSession().then(({ data: { session } }) => { if (session) setUser(session.user); });
        }, []);

        useEffect(() => {
            if (user) return window.DatabaseOps.subscribeData((data) => setProjects(data || []));
        }, [user]);

        const triggerSync = async (updatedProjects) => {
            setProjects(updatedProjects);
            setIsSyncing(true);
            await window.DatabaseOps.saveData(updatedProjects);
            setTimeout(() => setIsSyncing(false), 800);
        };

        const activeProject = projects.find(p => p.id === selectedId);

        // LOGIQUE DE DÉPLACEMENT DES LOTS (TASKS)
        const moveTask = (taskId, direction) => {
            const newProjects = [...projects];
            const pIdx = newProjects.findIndex(p => p.id === selectedId);
            const tasks = [...newProjects[pIdx].tasks];
            const index = tasks.findIndex(t => t.id === taskId);
            const newIndex = direction === 'up' ? index - 1 : index + 1;

            if (newIndex >= 0 && newIndex < tasks.length) {
                [tasks[index], tasks[newIndex]] = [tasks[newIndex], tasks[index]];
                newProjects[pIdx].tasks = tasks;
                triggerSync(newProjects);
            }
        };

        // LOGIQUE DE DÉPLACEMENT DES TÂCHES (SUBTASKS)
        const moveSubtask = (taskId, subId, direction) => {
            const newProjects = projects.map(p => p.id === selectedId ? {
                ...p, tasks: p.tasks.map(t => {
                    if (t.id !== taskId) return t;
                    const subs = [...t.subtasks];
                    const index = subs.findIndex(s => s.id === subId);
                    const newIndex = direction === 'up' ? index - 1 : index + 1;
                    if (newIndex >= 0 && newIndex < subs.length) {
                        [subs[index], subs[newIndex]] = [subs[newIndex], subs[index]];
                    }
                    return { ...t, subtasks: subs };
                })
            } : p);
            triggerSync(newProjects);
        };

        const updateSub = (tId, sId, data) => {
            const newProjects = projects.map(p => p.id === selectedId ? {
                ...p, tasks: p.tasks.map(t => t.id === tId ? {
                    ...t, subtasks: sId === 'new' ? [...t.subtasks, data] : t.subtasks.map(s => s.id === sId ? {...s, ...data} : s)
                } : t)
            } : p);
            triggerSync(newProjects);
        };

        // ... [Le reste du useMemo ganttRange et la vue Connexion/Header restent identiques] ...

        return (
            <div className="flex flex-col h-screen overflow-hidden">
                {/* Header identique à votre code */}
                <header className="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 w-full px-6 z-50">
                    <div className="flex flex-col">
                        <h1 className="font-black italic text-xs uppercase tracking-tighter">BTP Manager Pro</h1>
                        <div className="flex items-center mt-0.5">
                            <span className={`status-dot ${isSyncing ? 'sync-loading' : 'sync-success'}`}></span>
                            <span className="text-[8px] font-black uppercase opacity-50">{isSyncing ? 'Sync...' : 'Partagé'}</span>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setView('projects')} className="p-3 bg-white/10 rounded-xl"><Icon name="home" size={18}/></button>
                        <button onClick={() => { supabaseClient.auth.signOut(); setUser(null); }} className="p-3 bg-red-500/20 text-red-400 rounded-xl"><Icon name="logout" size={18}/></button>
                    </div>
                </header>

                <main className="flex-1 overflow-y-auto bg-slate-50 relative pb-32">
                    {/* Vues Projects, Planning, Budget identiques */}
                    {view === 'projects' && (/* ... code existant ... */)}
                    {view === 'planning' && (/* ... code existant ... */)}
                    {view === 'budget' && (/* ... code existant ... */)}

                    {/* VUE DETAILS MISE À JOUR AVEC FLÈCHES */}
                    {view === 'details' && activeProject && (
                        <div className="p-6 max-w-2xl mx-auto space-y-6 pb-40">
                            <h2 className="text-xl font-black uppercase italic text-slate-800">{activeProject.name}</h2>
                            {activeProject.tasks.map((task, tIdx) => (
                                <div key={task.id} className="bg-white p-6 rounded-[32px] border shadow-sm">
                                    <div className="flex justify-between mb-4 items-center">
                                        <div className="flex items-center gap-2">
                                            {/* Boutons de déplacement du LOT */}
                                            <div className="flex flex-col">
                                                <button onClick={() => moveTask(task.id, 'up')} className="text-slate-300 hover:text-blue-600 disabled:opacity-10" disabled={tIdx === 0}><Icon name="up" size={14}/></button>
                                                <button onClick={() => moveTask(task.id, 'down')} className="text-slate-300 hover:text-blue-600 disabled:opacity-10" disabled={tIdx === activeProject.tasks.length - 1}><Icon name="down" size={14}/></button>
                                            </div>
                                            <h4 className="font-black uppercase text-blue-600 text-[10px] tracking-widest cursor-pointer" onClick={() => setDialog({open: true, title: "Lot ?", value: task.title, type: 'input', onConfirm: (v) => triggerSync(projects.map(p => p.id === selectedId ? {...p, tasks: p.tasks.map(t => t.id === task.id ? {...t, title: v} : t)} : p))})}>{task.title}</h4>
                                        </div>
                                        <button onClick={() => setDialog({open: true, title: "Supprimer lot ?", type: 'confirm', onConfirm: () => triggerSync(projects.map(p => p.id === selectedId ? {...p, tasks: p.tasks.filter(t => t.id !== task.id)} : p))})} className="text-slate-200 hover:text-red-500"><Icon name="trash" size={14}/></button>
                                    </div>
                                    
                                    {task.subtasks.map((sub, sIdx) => (
                                        <div key={sub.id} className="mb-3 bg-slate-50 p-4 rounded-2xl border border-slate-100 flex gap-3">
                                            {/* Boutons de déplacement de la TÂCHE */}
                                            <div className="flex flex-col justify-center gap-1 border-r pr-2 border-slate-200">
                                                <button onClick={() => moveSubtask(task.id, sub.id, 'up')} className="text-slate-300 hover:text-blue-600 disabled:opacity-10" disabled={sIdx === 0}><Icon name="up" size={12}/></button>
                                                <button onClick={() => moveSubtask(task.id, sub.id, 'down')} className="text-slate-300 hover:text-blue-600 disabled:opacity-10" disabled={sIdx === task.subtasks.length - 1}><Icon name="down" size={12}/></button>
                                            </div>

                                            <div className="flex-1">
                                                <div className="flex justify-between items-center mb-2 font-black text-xs uppercase">
                                                    <span onClick={() => setDialog({open: true, title: "Tâche ?", value: sub.title, type: 'input', onConfirm: (v) => updateSub(task.id, sub.id, {title: v})})}>{sub.title}</span>
                                                    <button onClick={() => setLinkDialog({ open: true, taskId: task.id, subId: sub.id })} className="text-blue-500 bg-white p-2 rounded-xl border border-blue-50 shadow-sm"><Icon name="link" size={12}/></button>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input type="date" value={sub.date} onChange={e => updateSub(task.id, sub.id, {date: e.target.value})} className="flex-1 p-2 rounded-xl text-xs font-bold outline-none bg-white"/>
                                                    <input type="number" value={sub.duration} placeholder="Jrs" onChange={e => updateSub(task.id, sub.id, {duration: e.target.value})} className="w-16 p-2 rounded-xl text-xs font-bold text-center outline-none bg-white"/>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={() => setDialog({open: true, title: "Tâche ?", value: "", type: 'input', onConfirm: (v) => updateSub(task.id, 'new', {id: Date.now().toString(), title: v, date: new Date().toISOString().split('T')[0], duration: 1, progress: 0, photos: []})})} className="w-full py-4 bg-white text-slate-400 font-black text-[9px] uppercase rounded-xl border-2 border-dashed border-slate-200">+ Tâche</button>
                                </div>
                            ))}
                            <button onClick={() => setDialog({open: true, title: "Lot ?", value: "", type: 'input', onConfirm: (v) => triggerSync(projects.map(p => p.id === selectedId ? {...p, tasks: [...p.tasks, {id: Date.now().toString(), title: v, subtasks: []}]} : p))})} className="w-full py-5 bg-blue-600 text-white font-black uppercase rounded-[32px] shadow-lg">+ Nouveau Lot</button>
                        </div>
                    )}
                    
                    {/* Vue tracking et modales identiques */}
                </main>
                {/* Barre de navigation identique */}
            </div>
        );
    }
</script>
