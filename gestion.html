<script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
        const [user, setUser] = useState(null);
        const [projects, setProjects] = useState([]);
        const [loading, setLoading] = useState(true); // État de chargement crucial

        useEffect(() => {
            // 1. Vérifier la session et charger les données immédiatement après
            const initApp = async () => {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    setUser(session.user);
                    // On récupère les données AVANT de libérer l'écran de chargement
                    const data = await window.DatabaseOps.fetchInitialData();
                    setProjects(data || []);
                }
                setLoading(false);
            };

            initApp();

            // 2. Écouter les changements d'état (connexion/déconnexion)
            const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    setUser(session.user);
                    const data = await window.DatabaseOps.fetchInitialData();
                    setProjects(data || []);
                } else {
                    setUser(null);
                    setProjects([]);
                }
                setLoading(false);
            });

            return () => subscription.unsubscribe();
        }, []);

        // Écran d'attente pour éviter de voir "Mes chantiers" vide par erreur
        if (loading) {
            return (
                <div className="h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-3">
                        <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-[10px] font-black uppercase tracking-widest text-slate-400">Synchronisation...</p>
                    </div>
                </div>
            );
        }

        // Si pas d'utilisateur après le chargement -> Formulaire de connexion
        if (!user) {
            return <AuthUI onLogin={setUser} />;
        }

        // Si utilisateur -> Liste des chantiers
        return (
            <div className="min-h-screen bg-slate-50 flex flex-col">
                <header className="bg-slate-900 text-white p-6 flex justify-between items-center shadow-xl">
                    <div>
                        <h1 className="font-black italic text-sm uppercase tracking-tighter">BTP Manager Pro</h1>
                        <div className="flex items-center mt-1">
                            <span className="w-2 h-2 bg-green-500 rounded-full mr-2 shadow-[0_0_8px_#22c55e]"></span>
                            <span className="text-[8px] font-black uppercase opacity-50 tracking-widest">Connecté</span>
                        </div>
                    </div>
                    <button onClick={() => supabaseClient.auth.signOut()} className="p-3 bg-white/10 rounded-2xl hover:bg-red-500/20 transition-colors">
                         <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    </button>
                </header>

                <main className="flex-1 p-6 max-w-xl mx-auto w-full">
                    <h2 className="text-2xl font-black uppercase italic mb-8 text-slate-800 tracking-tight">Mes Chantiers</h2>
                    
                    <div className="space-y-4">
                        {projects.map(project => (
                            <div key={project.id} className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex justify-between items-center group active:scale-95 transition-all">
                                <span className="font-black uppercase text-sm tracking-tight text-slate-700">{project.name}</span>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => {/* Logique edit */}} className="p-2 text-slate-300 hover:text-blue-600"><Icon name="edit" size={18}/></button>
                                    <a href={`gestion.html?id=${project.id}`} className="p-3 bg-slate-50 rounded-2xl text-slate-400 group-hover:bg-blue-600 group-hover:text-white transition-all">
                                        <Icon name="right" size={20}/>
                                    </a>
                                </div>
                            </div>
                        ))}

                        <button 
                            onClick={() => {/* Logique nouveau chantier */}}
                            className="w-full py-8 border-4 border-dashed border-slate-200 rounded-[40px] text-slate-300 font-black uppercase tracking-widest hover:border-blue-400 hover:text-blue-500 transition-all"
                        >
                            + Nouveau Chantier
                        </button>
                    </div>
                </main>
            </div>
        );
    }
</script>
