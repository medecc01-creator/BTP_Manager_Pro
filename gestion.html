<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
        const [user, setUser] = useState(null);
        const [projects, setProjects] = useState([]);
        const [loading, setLoading] = useState(true);
        const retryCount = useRef(0);

        // Fonction de chargement isolée pour pouvoir la répéter
        const fetchData = async () => {
            console.log("Tentative de récupération des données...");
            const data = await window.DatabaseOps.fetchInitialData();
            
            if (data && data.length > 0) {
                setProjects(data);
                setLoading(false);
                return true;
            }
            return false;
        };

        useEffect(() => {
            const init = async () => {
                // On attend que Supabase récupère la session du stockage local
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    setUser(session.user);
                    const success = await fetchData();
                    
                    // SI TOUJOURS VIDE : On force un retry après 1.5s (le temps que le réseau stabilise)
                    if (!success) {
                        setTimeout(async () => {
                            const secondChance = await fetchData();
                            if (!secondChance) setLoading(false); // On abandonne le loading même si vide
                        }, 1500);
                    }
                } else {
                    setLoading(false);
                }
            };

            init();

            // Gestionnaire d'état d'auth (plus réactif que le getSession seul)
            const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    setUser(session.user);
                    fetchData();
                } else {
                    setUser(null);
                    setProjects([]);
                }
            });

            return () => subscription.unsubscribe();
        }, []);

        if (loading) {
            return (
                <div className="h-screen flex items-center justify-center bg-slate-900">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-[10px] font-black uppercase tracking-[0.2em] text-blue-400 animate-pulse">Initialisation Database</p>
                    </div>
                </div>
            );
        }

        if (!user) return <AuthUI onLogin={setUser} />;

        return (
            <div className="min-h-screen bg-slate-50 flex flex-col">
                <header className="bg-slate-900 text-white p-6 flex justify-between items-center shadow-xl">
                    <div className="flex flex-col">
                        <h1 className="font-black italic text-sm uppercase tracking-tighter">BTP Manager Pro</h1>
                        <div className="flex items-center mt-1">
                            <span className="w-2 h-2 bg-green-500 rounded-full mr-2 shadow-[0_0_8px_#22c55e]"></span>
                            <span className="text-[8px] font-black uppercase opacity-50 tracking-widest">Temps Réel Actif</span>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        {/* Bouton de secours si jamais ça ne s'affiche toujours pas */}
                        <button onClick={fetchData} className="p-3 bg-white/5 rounded-2xl text-slate-400 hover:text-white">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                        </button>
                        <button onClick={() => supabaseClient.auth.signOut()} className="p-3 bg-red-500/10 rounded-2xl text-red-500">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                        </button>
                    </div>
                </header>

                <main className="flex-1 p-6 max-w-xl mx-auto w-full">
                    <div className="flex justify-between items-end mb-8">
                        <h2 className="text-2xl font-black uppercase italic text-slate-800 tracking-tight text-left">Mes Chantiers</h2>
                        <span className="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase">{projects.length} PROJETS</span>
                    </div>
                    
                    <div className="space-y-4">
                        {projects.length === 0 ? (
                            <div className="py-20 text-center flex flex-col items-center">
                                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                </div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Aucun chantier trouvé</p>
                                <button onClick={() => {/* Logique nouveau */}} className="px-8 py-4 bg-blue-600 text-white rounded-[24px] font-black uppercase text-[10px] shadow-lg">+ Créer le premier</button>
                            </div>
                        ) : (
                            projects.map(project => (
                                <div key={project.id} className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex justify-between items-center group active:scale-95 transition-all">
                                    <span className="font-black uppercase text-sm tracking-tight text-slate-700">{project.name}</span>
                                    <div className="flex items-center gap-3">
                                        <a href={`gestion.html?id=${project.id}`} className="p-3 bg-slate-50 rounded-2xl text-slate-400 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                        </a>
                                    </div>
                                </div>
                            ))
                        )}

                        {projects.length > 0 && (
                            <button 
                                onClick={() => {/* Logique nouveau */}}
                                className="w-full py-8 border-4 border-dashed border-slate-200 rounded-[40px] text-slate-300 font-black uppercase tracking-widest hover:border-blue-400 hover:text-blue-500 transition-all mt-4"
                            >
                                + Nouveau Chantier
                            </button>
                        )}
                    </div>
                </main>
            </div>
        );
    }
</script>
